<UserControl x:Class="Finly.Pages.BudgetsPage"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:ctrls="clr-namespace:Finly.Views.Controls"
             xmlns:local="clr-namespace:Finly.Pages"
             mc:Ignorable="d"
             Background="{DynamicResource App.Background}">

	<UserControl.Resources>

		<!-- ===== Karty (jak w GoalsPage / Dashboard KPI) ===== -->
		<Style x:Key="Card" TargetType="Border">
			<Setter Property="Background"      Value="{DynamicResource Surface.Background}"/>
			<Setter Property="BorderBrush"     Value="{DynamicResource Surface.Border}"/>
			<Setter Property="BorderThickness" Value="1"/>
			<Setter Property="CornerRadius"    Value="10"/>
			<Setter Property="Padding"         Value="12"/>
		</Style>

		<Style x:Key="AccentCard" TargetType="Border" BasedOn="{StaticResource Card}">
			<Setter Property="BorderBrush"     Value="{DynamicResource Brand.Blue}"/>
			<Setter Property="BorderThickness" Value="2"/>
			<Setter Property="Margin"          Value="0,0,16,0"/>
		</Style>

		<Style x:Key="CardHeader" TargetType="TextBlock">
			<Setter Property="FontSize"   Value="18"/>
			<Setter Property="FontWeight" Value="Bold"/>
			<Setter Property="Foreground" Value="{DynamicResource App.Foreground}"/>
		</Style>

		<Style x:Key="KpiValueStyle" TargetType="TextBlock">
			<Setter Property="FontSize"   Value="24"/>
			<Setter Property="FontWeight" Value="Bold"/>
			<Setter Property="Margin"     Value="0,6,0,0"/>
			<Setter Property="Foreground" Value="{DynamicResource App.Foreground}"/>
		</Style>

		<!-- Kolory KPI kwot -->
		<Style x:Key="PlannedAmountStyle" TargetType="TextBlock" BasedOn="{StaticResource KpiValueStyle}">
			<Setter Property="Foreground" Value="{DynamicResource Brand.Blue}"/>
		</Style>

		<Style x:Key="SpentAmountStyle" TargetType="TextBlock" BasedOn="{StaticResource KpiValueStyle}">
			<!-- czerwony (bez zależności od zasobów, stabilne) -->
			<Setter Property="Foreground" Value="#FFD84A4A"/>
		</Style>

		<Style x:Key="RemainingAmountStyle" TargetType="TextBlock" BasedOn="{StaticResource KpiValueStyle}">
			<Setter Property="Foreground" Value="{DynamicResource Brand.Orange}"/>
		</Style>

		<!-- ===== MINI TABLE STYLES (jak DashboardPage) ===== -->
		<Style x:Key="MiniTableHeaderBorder" TargetType="Border">
			<Setter Property="Background" Value="{DynamicResource Surface.Background}"/>
			<Setter Property="Padding" Value="6,4"/>
			<Setter Property="Margin" Value="0,0,0,6"/>
			<Setter Property="CornerRadius" Value="6"/>
		</Style>

		<Style x:Key="MiniTableHeaderText" TargetType="TextBlock">
			<Setter Property="FontSize" Value="11"/>
			<Setter Property="FontWeight" Value="SemiBold"/>
			<Setter Property="Foreground" Value="{DynamicResource App.Foreground}"/>
			<Setter Property="Opacity" Value="0.8"/>
			<Setter Property="Margin" Value="6,0,6,0"/>
		</Style>

		<Style x:Key="MiniTableCellText" TargetType="TextBlock">
			<Setter Property="Foreground" Value="{DynamicResource App.Foreground}"/>
			<Setter Property="VerticalAlignment" Value="Center"/>
			<Setter Property="Margin" Value="6,2,6,2"/>
			<Setter Property="TextTrimming" Value="CharacterEllipsis"/>
			<Setter Property="TextWrapping" Value="NoWrap"/>
		</Style>

		<!-- ====== TEMPLATES: Budgets table ====== -->

		<!-- Header -->
		<DataTemplate x:Key="BudgetsHeaderTemplate">
			<Border Style="{StaticResource MiniTableHeaderBorder}">
				<Grid>
					<Grid.ColumnDefinitions>
						<ColumnDefinition SharedSizeGroup="bName" Width="220"/>
						<ColumnDefinition SharedSizeGroup="bType" Width="120"/>
						<ColumnDefinition SharedSizeGroup="bPeriod" Width="200"/>
						<ColumnDefinition SharedSizeGroup="bPlan" Width="120"/>
						<ColumnDefinition SharedSizeGroup="bSpent" Width="120"/>
						<ColumnDefinition SharedSizeGroup="bRem" Width="120"/>
					</Grid.ColumnDefinitions>

					<TextBlock Grid.Column="0" Text="Nazwa" Style="{StaticResource MiniTableHeaderText}"/>
					<TextBlock Grid.Column="1" Text="Typ" Style="{StaticResource MiniTableHeaderText}"/>
					<TextBlock Grid.Column="2" Text="Okres" Style="{StaticResource MiniTableHeaderText}"/>

					<TextBlock Grid.Column="3" Text="Zaplanowane"
                               Style="{StaticResource MiniTableHeaderText}"
                               HorizontalAlignment="Right"/>

					<TextBlock Grid.Column="4" Text="Wydano"
                               Style="{StaticResource MiniTableHeaderText}"
                               HorizontalAlignment="Right"/>

					<TextBlock Grid.Column="5" Text="Pozostało"
                               Style="{StaticResource MiniTableHeaderText}"
                               HorizontalAlignment="Right"/>
				</Grid>
			</Border>
		</DataTemplate>

		<!-- Row -->
		<DataTemplate x:Key="BudgetsRowTemplate">
			<Grid Margin="0,2" MinHeight="26">
				<Grid.ColumnDefinitions>
					<ColumnDefinition SharedSizeGroup="bName" Width="220"/>
					<ColumnDefinition SharedSizeGroup="bType" Width="120"/>
					<ColumnDefinition SharedSizeGroup="bPeriod" Width="200"/>
					<ColumnDefinition SharedSizeGroup="bPlan" Width="120"/>
					<ColumnDefinition SharedSizeGroup="bSpent" Width="120"/>
					<ColumnDefinition SharedSizeGroup="bRem" Width="120"/>
				</Grid.ColumnDefinitions>

				<TextBlock Grid.Column="0" Text="{Binding Name}" Style="{StaticResource MiniTableCellText}"/>
				<TextBlock Grid.Column="1" Text="{Binding TypeDisplay}" Style="{StaticResource MiniTableCellText}"/>
				<TextBlock Grid.Column="2" Text="{Binding Period}" Style="{StaticResource MiniTableCellText}"/>

				<TextBlock Grid.Column="3"
                           Text="{Binding PlannedAmount, StringFormat={}{0:N2} zł}"
                           Style="{StaticResource MiniTableCellText}"
                           Foreground="{DynamicResource Brand.Blue}"
                           HorizontalAlignment="Right"
                           TextAlignment="Right"/>

				<TextBlock Grid.Column="4"
                           Text="{Binding SpentAmount, StringFormat={}{0:N2} zł}"
                           Style="{StaticResource MiniTableCellText}"
                           Foreground="#FFD84A4A"
                           HorizontalAlignment="Right"
                           TextAlignment="Right"/>

				<TextBlock Grid.Column="5"
                           Text="{Binding RemainingAmount, StringFormat={}{0:N2} zł}"
                           Style="{StaticResource MiniTableCellText}"
                           Foreground="{DynamicResource Brand.Orange}"
                           HorizontalAlignment="Right"
                           TextAlignment="Right"/>
			</Grid>
		</DataTemplate>

		<!-- ===== KAFEL „DODAJ BUDŻET” (identyczny jak w GoalsPage) ===== -->
		<DataTemplate DataType="{x:Type local:AddBudgetTile}">
			<Border Style="{StaticResource Card}"
                    Width="260"
                    Cursor="Hand"
                    MouseLeftButtonUp="AddBudgetCard_Click">
				<Grid>
					<Border Margin="10"
                            BorderThickness="1"
                            CornerRadius="8"
                            BorderBrush="{DynamicResource Surface.Border}"/>
					<StackPanel HorizontalAlignment="Center"
                                VerticalAlignment="Center"
                                Margin="0,16,0,16">
						<TextBlock Text="+"
                                   FontSize="28"
                                   FontWeight="Bold"
                                   HorizontalAlignment="Center"
                                   Foreground="{DynamicResource App.Foreground}"/>
						<TextBlock Text="Dodaj budżet"
                                   Margin="0,6,0,0"
                                   FontSize="13"
                                   FontWeight="SemiBold"
                                   Foreground="{DynamicResource App.Foreground}"
                                   HorizontalAlignment="Center"/>
					</StackPanel>
				</Grid>
			</Border>
		</DataTemplate>

	</UserControl.Resources>

	<ScrollViewer VerticalScrollBarVisibility="Auto"
                  HorizontalScrollBarVisibility="Disabled"
                  PanningMode="VerticalOnly">

		<Grid Margin="24">
			<Grid.RowDefinitions>
				<RowDefinition Height="Auto"/>
				<!-- KPI -->
				<RowDefinition Height="Auto"/>
				<!-- Nagłówek + separator -->
				<RowDefinition Height="Auto"/>
				<!-- Filtry live -->
				<RowDefinition Height="Auto"/>
				<!-- Add tile -->
				<RowDefinition Height="*"/>
				<!-- Tabela -->
			</Grid.RowDefinitions>

			<!-- ===== GÓRA: KPI (3 kafelki) ===== -->
			<Grid Grid.Row="0" Margin="0,0,0,12">
				<Grid.ColumnDefinitions>
					<ColumnDefinition Width="*"/>
					<ColumnDefinition Width="*"/>
					<ColumnDefinition Width="*"/>
				</Grid.ColumnDefinitions>

				<Border Grid.Column="0" Style="{StaticResource AccentCard}">
					<StackPanel>
						<TextBlock x:Name="KpiBudgetName_Planned" Text="(brak budżetu)" Style="{StaticResource CardHeader}"/>
						<TextBlock x:Name="KpiBudgetType_Planned" Text="" Foreground="{DynamicResource App.Foreground}" Opacity="0.85"/>
						<TextBlock Text="Zaplanowano" Foreground="{DynamicResource App.Foreground}" Opacity="0.85" Margin="0,8,0,0"/>
						<TextBlock x:Name="KpiPlannedText" Text="0,00 zł" Style="{StaticResource PlannedAmountStyle}"/>
					</StackPanel>
				</Border>

				<Border Grid.Column="1" Style="{StaticResource AccentCard}">
					<StackPanel>
						<TextBlock x:Name="KpiBudgetName_Spent" Text="(brak budżetu)" Style="{StaticResource CardHeader}"/>
						<TextBlock x:Name="KpiBudgetType_Spent" Text="" Foreground="{DynamicResource App.Foreground}" Opacity="0.85"/>
						<TextBlock Text="Wydano" Foreground="{DynamicResource App.Foreground}" Opacity="0.85" Margin="0,8,0,0"/>
						<TextBlock x:Name="KpiSpentText" Text="0,00 zł" Style="{StaticResource SpentAmountStyle}"/>
					</StackPanel>
				</Border>

				<Border Grid.Column="2" Style="{StaticResource AccentCard}" Margin="0">
					<StackPanel>
						<TextBlock x:Name="KpiBudgetName_Remaining" Text="(brak budżetu)" Style="{StaticResource CardHeader}"/>
						<TextBlock x:Name="KpiBudgetType_Remaining" Text="" Foreground="{DynamicResource App.Foreground}" Opacity="0.85"/>
						<TextBlock Text="Pozostało" Foreground="{DynamicResource App.Foreground}" Opacity="0.85" Margin="0,8,0,0"/>
						<TextBlock x:Name="KpiRemainingText" Text="0,00 zł" Style="{StaticResource RemainingAmountStyle}"/>
					</StackPanel>
				</Border>
			</Grid>

			<!-- ===== Nagłówek + separator (jak Cele) ===== -->
			<StackPanel Grid.Row="1" Margin="0,0,0,12">
				<TextBlock Text="Budżety"
                           FontSize="24"
                           FontWeight="Bold"
                           Foreground="{DynamicResource App.Foreground}"
                           Margin="0,4,0,8"/>

				<Separator Height="1"
                           Background="{DynamicResource Surface.Border}"
                           Opacity="0.8"
                           Margin="0,0,0,0"/>
			</StackPanel>

			<!-- ===== Filtry LIVE (bez przycisków) ===== -->
			<Grid Grid.Row="2" Margin="0,0,0,12">
				<Grid.ColumnDefinitions>
					<ColumnDefinition Width="240"/>
					<ColumnDefinition Width="12"/>
					<ColumnDefinition Width="*"/>
				</Grid.ColumnDefinitions>

				<!-- Typ budżetu -->
				<StackPanel Grid.Column="0">
					<TextBlock Text="Typ budżetu"
                               Foreground="{DynamicResource App.Foreground}"
                               Opacity="0.85"
                               Margin="0,0,0,6"/>
					<ComboBox x:Name="TypeFilterCombo"
                              SelectionChanged="LiveFilter_Changed"
                              Height="34">
						<ComboBoxItem Content="Wszystkie" Tag="Wszystkie"/>
						<ComboBoxItem Content="Tygodniowy" Tag="Weekly"/>
						<ComboBoxItem Content="Miesięczny" Tag="Monthly"/>
						<ComboBoxItem Content="Roczny" Tag="Yearly"/>
					</ComboBox>
				</StackPanel>

				<!-- Szukaj -->
				<StackPanel Grid.Column="2">
					<TextBlock Text="Szukaj (nazwa / typ)"
                               Foreground="{DynamicResource App.Foreground}"
                               Opacity="0.85"
                               Margin="0,0,0,6"/>
					<TextBox x:Name="SearchBox"
                             TextChanged="LiveFilter_TextChanged"
                             Height="34"/>
				</StackPanel>
			</Grid>

			<!-- ===== Kafelek „Dodaj budżet” ===== -->
			<ItemsControl Grid.Row="3" x:Name="AddBudgetRepeater" Margin="0,0,0,12">
				<ItemsControl.ItemsPanel>
					<ItemsPanelTemplate>
						<WrapPanel/>
					</ItemsPanelTemplate>
				</ItemsControl.ItemsPanel>
			</ItemsControl>

			<!-- ===== Tabela budżetów: MiniTableControl (jak Dashboard) ===== -->
			<Border Grid.Row="4" Style="{StaticResource Card}" Padding="16">
				<StackPanel>
					<Grid Margin="0,0,0,8">
						<Grid.ColumnDefinitions>
							<ColumnDefinition Width="*"/>
							<ColumnDefinition Width="Auto"/>
						</Grid.ColumnDefinitions>

						<TextBlock x:Name="StatusText"
                                   Foreground="{DynamicResource App.Foreground}"
                                   Opacity="0.85"
                                   VerticalAlignment="Center"/>

						<StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
							<TextBlock Text="Zaplanowano: "
                                       Foreground="{DynamicResource App.Foreground}"
                                       Opacity="0.85"/>
							<TextBlock x:Name="TotalPlannedText"
                                       Foreground="{DynamicResource Brand.Blue}"
                                       FontWeight="Bold"/>
							<TextBlock Text="   Wydano: "
                                       Foreground="{DynamicResource App.Foreground}"
                                       Opacity="0.85"
                                       Margin="14,0,0,0"/>
							<TextBlock x:Name="TotalSpentText"
                                       Foreground="#FFD84A4A"
                                       FontWeight="Bold"/>
							<TextBlock Text="   Pozostało: "
                                       Foreground="{DynamicResource App.Foreground}"
                                       Opacity="0.85"
                                       Margin="14,0,0,0"/>
							<TextBlock x:Name="TotalRemainingText"
                                       Foreground="{DynamicResource Brand.Orange}"
                                       FontWeight="Bold"/>
						</StackPanel>
					</Grid>

					<ctrls:MiniTableControl x:Name="BudgetsTable"
                                            HeaderTemplate="{StaticResource BudgetsHeaderTemplate}"
                                            RowTemplate="{StaticResource BudgetsRowTemplate}"
                                            SelectionMode="Single"/>
				</StackPanel>
			</Border>

		</Grid>
	</ScrollViewer>
</UserControl>
