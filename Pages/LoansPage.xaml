<UserControl x:Class="Finly.Pages.LoansPage"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:Finly.ViewModels"
             Background="{DynamicResource App.Background}">

	<UserControl.Resources>

		<!-- ===== LOCAL, SAFE STYLES (only for this page) ===== -->

		<Style x:Key="LoansCard" TargetType="Border">
			<Setter Property="Background" Value="{DynamicResource Surface.Background}"/>
			<Setter Property="BorderBrush" Value="{DynamicResource Surface.Border}"/>
			<Setter Property="BorderThickness" Value="1"/>
			<Setter Property="CornerRadius" Value="10"/>
			<Setter Property="Padding" Value="12"/>
		</Style>

		<Style x:Key="LoansKpiCard" TargetType="Border" BasedOn="{StaticResource LoansCard}">
			<Setter Property="BorderBrush" Value="{DynamicResource Brand.Red}"/>
			<Setter Property="BorderThickness" Value="2"/>
			<Setter Property="MinWidth" Value="260"/>
			<Setter Property="MaxWidth" Value="360"/>
			<Setter Property="Margin" Value="0,0,12,12"/>
		</Style>

		<Style x:Key="LoansKpiHeader" TargetType="TextBlock">
			<Setter Property="FontSize" Value="12"/>
			<Setter Property="Foreground" Value="{DynamicResource App.Foreground}"/>
			<Setter Property="Opacity" Value="0.85"/>
		</Style>

		<Style x:Key="LoansKpiValue" TargetType="TextBlock">
			<Setter Property="FontSize" Value="26"/>
			<Setter Property="FontWeight" Value="Bold"/>
			<Setter Property="Foreground" Value="{DynamicResource App.Foreground}"/>
			<Setter Property="Margin" Value="0,2,0,0"/>
		</Style>

		<Style x:Key="FinancialAnalysisCardBorderStyle" TargetType="Border" BasedOn="{StaticResource LoansCard}">
			<Setter Property="BorderBrush" Value="{DynamicResource Brand.Orange}"/>
			<Setter Property="BorderThickness" Value="2"/>
		</Style>

		<Style x:Key="FinancialAnalysisCardHeaderStyle" TargetType="TextBlock">
			<Setter Property="FontSize" Value="16"/>
			<Setter Property="FontWeight" Value="Bold"/>
			<Setter Property="Foreground" Value="{DynamicResource App.Foreground}"/>
			<Setter Property="Opacity" Value="1"/>
		</Style>

		<Style x:Key="LoansPrimarySmallButton" TargetType="Button" BasedOn="{StaticResource PrimaryButton}">
			<Setter Property="MinHeight" Value="30"/>
			<Setter Property="Padding" Value="12,4"/>
			<Setter Property="MinWidth" Value="120"/>
			<Setter Property="HorizontalContentAlignment" Value="Center"/>
			<Setter Property="VerticalContentAlignment" Value="Center"/>
			<Setter Property="ContentTemplate">
				<Setter.Value>
					<DataTemplate>
						<TextBlock Text="{Binding}" TextWrapping="Wrap" TextAlignment="Center"/>
					</DataTemplate>
				</Setter.Value>
			</Setter>
		</Style>

		<Style x:Key="LoansPrimarySmallButtonNoWrap" TargetType="Button" BasedOn="{StaticResource LoansPrimarySmallButton}">
			<Setter Property="MinWidth" Value="150"/>
			<Setter Property="ContentTemplate">
				<Setter.Value>
					<DataTemplate>
						<TextBlock Text="{Binding}" TextWrapping="NoWrap" TextAlignment="Center"/>
					</DataTemplate>
				</Setter.Value>
			</Setter>
		</Style>

	</UserControl.Resources>

	<ScrollViewer VerticalScrollBarVisibility="Auto"
                  HorizontalScrollBarVisibility="Disabled"
                  Padding="0"
                  Background="Transparent">

		<StackPanel Margin="16">

			<!-- ===== Header ===== -->
			<StackPanel Orientation="Horizontal"
                        VerticalAlignment="Center"
                        Margin="0,0,0,12">
				<TextBlock Text="Kredyty"
                           FontSize="20"
                           FontWeight="Bold"
                           Foreground="{DynamicResource App.Foreground}"/>
			</StackPanel>

			<!-- ===== KPI + Analizy finansowe ===== -->
			<Grid Margin="0,0,0,12">
				<Grid.ColumnDefinitions>
					<ColumnDefinition Width="*" />
					<ColumnDefinition Width="Auto" MinWidth="320" />
				</Grid.ColumnDefinitions>

				<!-- KPI (left) -->
				<WrapPanel Grid.Column="0"
                           HorizontalAlignment="Left"
                           VerticalAlignment="Top"
                           Margin="0,0,12,0">

					<Border Style="{StaticResource LoansKpiCard}">
						<StackPanel>
							<TextBlock Text="Całkowita kwota wszystkich kredytów"
                                       Style="{StaticResource LoansKpiHeader}"/>
							<TextBlock x:Name="TotalLoansTileAmount"
                                       Text="0,00 zł"
                                       Style="{StaticResource LoansKpiValue}"/>
						</StackPanel>
					</Border>

					<Border Style="{StaticResource LoansKpiCard}">
						<StackPanel>
							<TextBlock Text="Miesięczny koszt rat kredytów"
                                       Style="{StaticResource LoansKpiHeader}"/>
							<TextBlock x:Name="MonthlyLoansTileAmount"
                                       Text="0,00 zł"
                                       Style="{StaticResource LoansKpiValue}"/>
						</StackPanel>
					</Border>

					<!-- Add loan tile -->
					<Border Margin="0,0,12,12"
                            Padding="18"
                            Background="{DynamicResource Surface.Background}"
                            BorderBrush="{DynamicResource Surface.Border}"
                            BorderThickness="1"
                            CornerRadius="10"
                            Cursor="Hand"
                            MinWidth="260"
                            MaxWidth="360"
                            MouseDown="AddLoanCard_Click">
						<StackPanel HorizontalAlignment="Center"
                                    VerticalAlignment="Center">
							<TextBlock Text="➕"
                                       FontSize="22"
                                       HorizontalAlignment="Center"
                                       Foreground="{DynamicResource App.Foreground}"/>
							<TextBlock Text="Dodaj kredyt"
                                       FontWeight="SemiBold"
                                       HorizontalAlignment="Center"
                                       Foreground="{DynamicResource App.Foreground}"/>
						</StackPanel>
					</Border>

				</WrapPanel>

				<!-- Analizy finansowe (right) -->
				<Border Grid.Column="1"
                        Style="{StaticResource FinancialAnalysisCardBorderStyle}"
                        HorizontalAlignment="Right"
                        MinWidth="320"
                        MaxWidth="420"
                        Margin="0,0,0,12">
					<StackPanel>

						<TextBlock Text="Analizy finansowe"
                                   Style="{StaticResource FinancialAnalysisCardHeaderStyle}"
                                   Margin="0,0,0,10"/>

						<ItemsControl x:Name="InsightsList">
							<ItemsControl.ItemTemplate>
								<DataTemplate DataType="{x:Type vm:LoanInsightVm}">
									<TextBlock Foreground="{DynamicResource App.Foreground}"
                                               Margin="0,2,0,2"
                                               TextWrapping="Wrap">
										<Run Text="{Binding Label, Mode=OneWay}"/>
										<Run Text=": "/>
										<Run Text="{Binding Value, Mode=OneWay}" FontWeight="Bold"/>
									</TextBlock>
								</DataTemplate>
							</ItemsControl.ItemTemplate>
						</ItemsControl>

					</StackPanel>
				</Border>
			</Grid>

			<!-- ===== Loan Cards ===== -->
			<ItemsControl x:Name="LoansGrid">

				<ItemsControl.Resources>

					<DataTemplate DataType="{x:Type vm:LoanCardVm}">
						<Border Margin="0,0,12,12"
                                Background="{DynamicResource Surface.Background}"
                                BorderBrush="{DynamicResource Surface.Border}"
                                BorderThickness="1"
                                CornerRadius="10"
                                Padding="12"
                                MinWidth="420"
                                MaxWidth="420">

							<Grid>
								<Grid.RowDefinitions>
									<RowDefinition Height="Auto"/>
									<RowDefinition Height="Auto"/>
									<RowDefinition Height="Auto"/>
								</Grid.RowDefinitions>

								<!-- Header -->
								<StackPanel Grid.Row="0"
                                            Orientation="Horizontal"
                                            VerticalAlignment="Center">
									<TextBlock Text="🏠"
                                               FontSize="32"
                                               Margin="0,0,8,0"
                                               VerticalAlignment="Center"/>
									<TextBlock Text="{Binding Name}"
                                               FontWeight="Bold"
                                               Foreground="{DynamicResource App.Foreground}"
                                               VerticalAlignment="Center"/>
								</StackPanel>

								<!-- Middle -->
								<StackPanel Grid.Row="1" Margin="0,8,0,8">
									<TextBlock Text="Pozostało:"
                                               Foreground="Gray"
                                               FontSize="12"/>
									<TextBlock Text="{Binding PrincipalStr}"
                                               FontSize="20"
                                               FontWeight="Bold"
                                               Foreground="OrangeRed"/>

									<StackPanel Orientation="Horizontal"
                                                Margin="0,6,0,0"
                                                HorizontalAlignment="Left">
										<TextBlock Text="Oprocentowanie:"
                                                   Foreground="Gray"
                                                   FontSize="11"
                                                   Margin="0,0,6,0"/>
										<TextBlock Text="{Binding InterestRate, StringFormat={}{0}%}"
                                                   FontSize="12"
                                                   Foreground="{DynamicResource App.Foreground}"
                                                   Margin="0,0,12,0"/>
										<TextBlock Text="Kolejna rata:"
                                                   Foreground="Gray"
                                                   FontSize="11"
                                                   Margin="0,0,6,0"/>
										<TextBlock Text="{Binding NextPaymentInfo}"
                                                   FontSize="12"
                                                   Foreground="{DynamicResource App.Foreground}"/>
									</StackPanel>

									<ProgressBar Value="{Binding PercentPaidClamped, Mode=OneWay}"
                                                 Maximum="100"
                                                 Height="12"
                                                 Margin="0,8,0,0"/>

									<Grid Margin="0,8,0,0">
										<Grid.ColumnDefinitions>
											<ColumnDefinition Width="*" />
											<ColumnDefinition Width="*" />
										</Grid.ColumnDefinitions>

										<StackPanel Grid.Column="0">
											<TextBlock Text="Następna rata:"
                                                       Foreground="Gray"
                                                       FontSize="11"/>
											<TextBlock Text="{Binding NextPayment}"
                                                       FontSize="12"
                                                       Foreground="{DynamicResource App.Foreground}"/>
										</StackPanel>

										<StackPanel Grid.Column="1">
											<TextBlock Text="Do końca:"
                                                       Foreground="Gray"
                                                       FontSize="11"/>
											<TextBlock Text="{Binding RemainingTermStr}"
                                                       FontSize="12"
                                                       Foreground="{DynamicResource App.Foreground}"/>
										</StackPanel>
									</Grid>
								</StackPanel>

								<!-- Bottom actions -->
								<Grid Grid.Row="2" Margin="0,6,0,0">
									<Grid.ColumnDefinitions>
										<ColumnDefinition Width="*" />
										<ColumnDefinition Width="Auto" />
									</Grid.ColumnDefinitions>

									<!-- LEFT -->
									<StackPanel Grid.Column="0">
										<StackPanel Orientation="Horizontal">
											<Button Width="36" Height="36"
                                                    Margin="0,0,8,0"
                                                    Click="EditLoan_Click"
                                                    Tag="{Binding}"
                                                    ToolTip="Edytuj kredyt"
                                                    Style="{StaticResource EditIconButton}"/>

											<Button Width="36" Height="36"
                                                    Click="DeleteLoan_Click"
                                                    Tag="{Binding}"
                                                    ToolTip="Usuń kredyt"
                                                    Style="{StaticResource DeleteIconButton}"/>
										</StackPanel>

										<Border x:Name="DeleteConfirmPanel"
                                                Background="Transparent"
                                                Visibility="Collapsed"
                                                Margin="0,8,0,0">
											<StackPanel>
												<TextBlock Text="Czy na pewno chcesz usunąć ten kredyt?"
                                                           Foreground="OrangeRed"
                                                           FontWeight="Bold"
                                                           Margin="0,0,0,6"/>
												<StackPanel Orientation="Horizontal">
													<Button Content="Tak"
                                                            Width="80"
                                                            Margin="0,0,8,0"
                                                            Click="ConfirmDeleteLoan_Click"
                                                            Tag="{Binding}"/>
													<Button Content="Nie"
                                                            Width="80"
                                                            Click="DeleteCancel_Click"/>
												</StackPanel>
											</StackPanel>
										</Border>
									</StackPanel>

									<!-- RIGHT -->
									<StackPanel Grid.Column="1"
                                                Margin="12,0,0,0"
                                                VerticalAlignment="Top"
                                                MinWidth="170">

										<StackPanel Orientation="Horizontal" Margin="0,0,0,8">
											<Button Content="Symulacja nadpłaty"
                                                    Style="{StaticResource LoansPrimarySmallButton}"
                                                    Margin="0,0,8,0"
                                                    Click="ShowSimDialog_Click"
                                                    Tag="{Binding}"/>

											<Button Height="30"
                                                    Padding="12,0"
                                                    Click="CardAttachSchedule_Click"
                                                    Tag="{Binding}"
                                                    ToolTip="Załącz harmonogram spłat rat kredytu">
												<TextBlock Text="Załącz harmonogram"/>
											</Button>
										</StackPanel>

										<StackPanel Orientation="Horizontal">
											<Button Content="Nadpłać kredyt"
                                                    Style="{StaticResource LoansPrimarySmallButtonNoWrap}"
                                                    Margin="0,0,8,0"
                                                    Click="CardOverpay_Click"
                                                    Tag="{Binding}"/>

											<Button Height="30"
                                                    Padding="12,0"
                                                    Click="CardSchedule_Click"
                                                    Tag="{Binding}"
                                                    ToolTip="Harmonogram spłat rat kredytu">
												<TextBlock Text="Harmonogram spłat"/>
											</Button>
										</StackPanel>

									</StackPanel>
								</Grid>

							</Grid>
						</Border>
					</DataTemplate>

				</ItemsControl.Resources>

				<ItemsControl.ItemsPanel>
					<ItemsPanelTemplate>
						<WrapPanel IsItemsHost="True"
                                   ItemWidth="440"
                                   ItemHeight="Auto"/>
					</ItemsPanelTemplate>
				</ItemsControl.ItemsPanel>
			</ItemsControl>

		</StackPanel>
	</ScrollViewer>
</UserControl>
