<UserControl x:Class="Finly.Pages.ReportsPage"
 xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
 xmlns:ctrls="clr-namespace:Finly.Views.Controls"
 xmlns:vm="clr-namespace:Finly.ViewModels"
 xmlns:conv="clr-namespace:Finly.Helpers.Converters"
 Foreground="{StaticResource App.Foreground}">

 <UserControl.DataContext>
 <vm:ReportsViewModel />
 </UserControl.DataContext>

 <UserControl.Resources>
 <conv:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
 <conv:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter" />
 <!-- Vector fallback calendar icon (visible on dark theme). If you add Assets/Icons/kalendarz.png later, you can replace these Image Sources to point to the PNG. -->
 <DrawingImage x:Key="CalendarIcon">
 <DrawingImage.Drawing>
 <DrawingGroup>
 <!-- header bar -->
 <GeometryDrawing Brush="{StaticResource Control.Foreground}" Geometry="M1,2 L17,2 L17,5 L1,5 Z" />
 <!-- outer rectangle (use Pen element instead of Pen attribute) -->
 <GeometryDrawing Brush="{x:Null}">
 <GeometryDrawing.Pen>
 <Pen Brush="{StaticResource Surface.Border}" Thickness="1" />
 </GeometryDrawing.Pen>
 <GeometryDrawing.Geometry>
 <RectangleGeometry Rect="1,4,16,14" />
 </GeometryDrawing.Geometry>
 </GeometryDrawing>
 <!-- two rings (use EllipseGeometry for simplicity) -->
 <GeometryDrawing Brush="{StaticResource Control.Foreground}">
 <GeometryDrawing.Geometry>
 <EllipseGeometry Center="4,2" RadiusX="1" RadiusY="1" />
 </GeometryDrawing.Geometry>
 </GeometryDrawing>
 <GeometryDrawing Brush="{StaticResource Control.Foreground}">
 <GeometryDrawing.Geometry>
 <EllipseGeometry Center="14,2" RadiusX="1" RadiusY="1" />
 </GeometryDrawing.Geometry>
 </GeometryDrawing>
 <!-- small grid dots as rectangles -->
 <GeometryDrawing Brush="{StaticResource Control.Foreground}">
 <GeometryDrawing.Geometry>
 <GeometryGroup>
 <RectangleGeometry Rect="3,7,1,1" />
 <RectangleGeometry Rect="6,7,1,1" />
 <RectangleGeometry Rect="9,7,1,1" />
 <RectangleGeometry Rect="12,7,1,1" />
 <RectangleGeometry Rect="15,7,1,1" />
 </GeometryGroup>
 </GeometryDrawing.Geometry>
 </GeometryDrawing>
 </DrawingGroup>
 </DrawingImage.Drawing>
 </DrawingImage>
 <!-- Make popups/dropdowns/calendars use dark brushes by overriding system brush keys locally -->
 <SolidColorBrush x:Key="{x:Static SystemColors.WindowBrushKey}" Color="#26282D" />
 <SolidColorBrush x:Key="{x:Static SystemColors.WindowTextBrushKey}" Color="#EAEAEA" />
 <SolidColorBrush x:Key="{x:Static SystemColors.ControlBrushKey}" Color="#26282D" />
 <SolidColorBrush x:Key="{x:Static SystemColors.ControlTextBrushKey}" Color="#EAEAEA" />
 <SolidColorBrush x:Key="{x:Static SystemColors.HighlightBrushKey}" Color="#3B82F6" />
 <SolidColorBrush x:Key="{x:Static SystemColors.HighlightTextBrushKey}" Color="#FFFFFF" />

 <!-- Basic dark styles -->
 <Style TargetType="Button">
 <Setter Property="Background" Value="{StaticResource Control.Background}" />
 <Setter Property="Foreground" Value="{StaticResource Control.Foreground}" />
 <Setter Property="BorderBrush" Value="{StaticResource Surface.Border}" />
 <Setter Property="Padding" Value="6,4" />
 </Style>

 <Style TargetType="TextBox">
 <Setter Property="Background" Value="{StaticResource Control.Background}" />
 <Setter Property="Foreground" Value="{StaticResource Control.Foreground}" />
 <Setter Property="BorderBrush" Value="{StaticResource Surface.Border}" />
 <Setter Property="Padding" Value="4" />
 </Style>

 <Style TargetType="ComboBox">
 <Setter Property="Background" Value="{StaticResource Control.Background}" />
 <Setter Property="Foreground" Value="{StaticResource Control.Foreground}" />
 <Setter Property="BorderBrush" Value="{StaticResource Surface.Border}" />
 </Style>

 <Style TargetType="ComboBoxItem">
 <Setter Property="Background" Value="{StaticResource Control.Background}" />
 <Setter Property="Foreground" Value="{StaticResource Control.Foreground}" />
 <Setter Property="Padding" Value="6,2" />
 <Style.Triggers>
 <Trigger Property="IsSelected" Value="True">
 <Setter Property="Background" Value="{StaticResource Accent}" />
 <Setter Property="Foreground" Value="{StaticResource OnAccent}" />
 </Trigger>
 <Trigger Property="IsMouseOver" Value="True">
 <Setter Property="Background" Value="{StaticResource Sidebar.Hover}" />
 </Trigger>
 </Style.Triggers>
 </Style>

 <Style TargetType="DatePicker">
 <Setter Property="Background" Value="{StaticResource Control.Background}" />
 <Setter Property="Foreground" Value="{StaticResource Control.Foreground}" />
 <Setter Property="BorderBrush" Value="{StaticResource Surface.Border}" />
 </Style>

 <!-- Small toggle style for the blue segmented bar -->
 <Style x:Key="SegmentToggle" TargetType="ToggleButton">
 <Setter Property="Background" Value="{StaticResource Control.Background}" />
 <Setter Property="BorderBrush" Value="{StaticResource Surface.Border}" />
 <Setter Property="Foreground" Value="{StaticResource Control.Foreground}" />
 <Setter Property="Margin" Value="4,0" />
 <Setter Property="Template">
 <Setter.Value>
 <ControlTemplate TargetType="ToggleButton">
 <Border x:Name="Bd" Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="1" CornerRadius="6" Padding="6,4">
 <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
 </Border>
 <ControlTemplate.Triggers>
 <Trigger Property="IsChecked" Value="True">
 <Setter TargetName="Bd" Property="Background" Value="{StaticResource Accent}" />
 <Setter TargetName="Bd" Property="BorderBrush" Value="{StaticResource Accent.Pressed}" />
 <Setter Property="Foreground" Value="{StaticResource OnAccent}" />
 </Trigger>
 <Trigger Property="IsMouseOver" Value="True">
 <Setter TargetName="Bd" Property="Background" Value="{StaticResource Sidebar.Hover}" />
 </Trigger>
 </ControlTemplate.Triggers>
 </ControlTemplate>
 </Setter.Value>
 </Setter>
 </Style>

 <Style TargetType="TabItem">
 <Setter Property="Background" Value="{StaticResource Control.Background}" />
 <Setter Property="Foreground" Value="{StaticResource Control.Foreground}" />
 <Setter Property="Padding" Value="10,4" />
 <Setter Property="Margin" Value="0,0,4,0" />
 <Setter Property="BorderBrush" Value="{StaticResource Surface.Border}" />
 <Setter Property="BorderThickness" Value="1" />
 <Setter Property="Template">
 <Setter.Value>
 <ControlTemplate TargetType="TabItem">
 <Border x:Name="Bd"
 Background="{TemplateBinding Background}"
 BorderBrush="{TemplateBinding BorderBrush}"
 BorderThickness="{TemplateBinding BorderThickness}"
 CornerRadius="4,4,0,0"
 Padding="{TemplateBinding Padding}"
 Margin="{TemplateBinding Margin}">
 <ContentPresenter x:Name="Content" ContentSource="Header" HorizontalAlignment="Center" VerticalAlignment="Center" RecognizesAccessKey="True" />
 </Border>
 <ControlTemplate.Triggers>
 <Trigger Property="IsSelected" Value="True">
 <Setter TargetName="Bd" Property="Background" Value="{StaticResource Surface.Background}" />
 <Setter TargetName="Bd" Property="BorderBrush" Value="{StaticResource Accent}" />
 <Setter Property="Panel.ZIndex" Value="1" />
 </Trigger>
 <Trigger Property="IsMouseOver" Value="True">
 <Setter TargetName="Bd" Property="Background" Value="{StaticResource Sidebar.Hover}" />
 </Trigger>
 <Trigger Property="IsEnabled" Value="False">
 <Setter Property="Foreground" Value="#777777" />
 </Trigger>
 </ControlTemplate.Triggers>
 </ControlTemplate>
 </Setter.Value>
 </Setter>
 </Style>

 <Style TargetType="TabControl">
 <Setter Property="Background" Value="{StaticResource Control.Background}" />
 <Setter Property="Foreground" Value="{StaticResource Control.Foreground}" />
 <Setter Property="BorderBrush" Value="{StaticResource Surface.Border}" />
 <Setter Property="Template">
 <Setter.Value>
 <ControlTemplate TargetType="TabControl">
 <Grid>
 <Grid.RowDefinitions>
 <RowDefinition Height="Auto" />
 <RowDefinition Height="*" />
 </Grid.RowDefinitions>

 <!-- Header area -->
 <Border Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="0,0,0,1" Padding="6">
 <TabPanel IsItemsHost="True" Background="{TemplateBinding Background}" KeyboardNavigation.TabIndex="0" />
 </Border>

 <!-- Content area -->
 <Border Grid.Row="1" Background="{StaticResource Surface.Background}" BorderBrush="{StaticResource Surface.Border}" BorderThickness="1" CornerRadius="4" Padding="8" Margin="0,8,0,0">
 <ContentPresenter x:Name="PART_SelectedContentHost" ContentSource="SelectedContent" />
 </Border>
 </Grid>
 </ControlTemplate>
 </Setter.Value>
 </Setter>
 </Style>

 <Style TargetType="DataGrid">
 <Setter Property="Background" Value="{StaticResource Control.Background}" />
 <Setter Property="Foreground" Value="{StaticResource Control.Foreground}" />
 <Setter Property="RowBackground" Value="{x:Null}" />
 <Setter Property="AlternatingRowBackground" Value="{StaticResource Control.Background}" />
 <Setter Property="GridLinesVisibility" Value="None" />
 </Style>

 </UserControl.Resources>

 <!-- Main layout -->
 <Grid Margin="12,0,12,12" Background="{StaticResource App.Background}">
 <Grid.RowDefinitions>
 <RowDefinition Height="Auto" /> <!-- Top row: Filters / PeriodBar / Insights -->
 <RowDefinition Height="*" /> <!-- Main content below -->
 </Grid.RowDefinitions>
 <Grid.ColumnDefinitions>
 <ColumnDefinition Width="300" /> <!-- Filters -->
 <ColumnDefinition Width="*" /> <!-- Reports -->
 <ColumnDefinition Width="320" /> <!-- Insights -->
 </Grid.ColumnDefinitions>

 <!-- LEFT: Filters (moved to top row) -->
 <Border Grid.Row="0" Grid.Column="0" Background="{StaticResource Surface.Background}" Padding="12" CornerRadius="6" Margin="0,0,12,0" BorderBrush="{StaticResource Surface.Border}" BorderThickness="1">
 <StackPanel>
 <TextBlock Text="Filtry" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,8" />

 <TextBlock Text="Zakres dat" FontWeight="Bold" />
 <!-- Note about date range removed per design -->

 <TextBlock Text="Źródło" FontWeight="Bold" />
 <ComboBox SelectedValuePath="Value" SelectedValue="{Binding SelectedSource, Mode=TwoWay}" Margin="0,4,0,8">
 <ComboBoxItem Content="Wszystko" Tag="All" />
 <ComboBoxItem Content="Wolna gotówka" Tag="FreeCash" />
 <ComboBoxItem Content="Odłożona gotówka" Tag="SavedCash" />
 <ComboBoxItem Content="Konta bankowe" Tag="BankAccounts" />
 <ComboBoxItem Content="Koperty" Tag="Envelopes" />
 </ComboBox>

 <!-- Bank selector visible when Source = BankAccounts -->
 <StackPanel Orientation="Vertical" Margin="0,4,0,8" Visibility="{Binding ShowBankSelector, Converter={StaticResource BoolToVisibilityConverter}}">
 <TextBlock Text="Konto" FontWeight="Bold" />
 <ComboBox ItemsSource="{Binding BankAccounts}" SelectedItem="{Binding SelectedBankAccount}" DisplayMemberPath="AccountName" SelectedValuePath="Id" />
 </StackPanel>

 <!-- Envelope selector visible when Source = Envelopes -->
 <StackPanel Orientation="Vertical" Margin="0,4,0,8" Visibility="{Binding ShowEnvelopeSelector, Converter={StaticResource BoolToVisibilityConverter}}">
 <TextBlock Text="Koperta" FontWeight="Bold" />
 <ComboBox ItemsSource="{Binding Envelopes}" SelectedItem="{Binding SelectedEnvelope}" />
 </StackPanel>

 <TextBlock Text="Kategoria" FontWeight="Bold" />
 <ComboBox ItemsSource="{Binding Categories}" SelectedItem="{Binding SelectedCategory}" Margin="0,4,0,8" />

 <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
 <Button Content="Odśwież" Command="{Binding RefreshCommand}" Width="100" />
 <Button Content="Eksport" Width="100" Margin="8,0,0,0">
 <Button.ContextMenu>
 <ContextMenu>
 <MenuItem Header="CSV" Command="{Binding ExportCsvCommand}" />
 <MenuItem Header="Excel" Command="{Binding ExportExcelCommand}" />
 <MenuItem Header="PDF" Command="{Binding ExportPdfCommand}" />
 </ContextMenu>
 </Button.ContextMenu>
 </Button>
 </StackPanel>
 </StackPanel>
 </Border>

 <!-- CENTER: Reports area -->
 <Border Grid.Row="0" Grid.RowSpan="2" Grid.Column="1" Background="{StaticResource Surface.Background}" Padding="12" CornerRadius="6" Margin="0,0,12,0" BorderBrush="{StaticResource Surface.Border}" BorderThickness="1">
 <Grid>
 <Grid.RowDefinitions>
 <RowDefinition Height="Auto" /> <!-- Period bar -->
 <RowDefinition Height="Auto" /> <!-- Tabs -->
 <RowDefinition Height="*" /> <!-- Charts -->
 </Grid.RowDefinitions>

 <!-- Use shared PeriodBarControl (visual + behavior match Dashboard) -->
 <ctrls:PeriodBarControl x:Name="PeriodBar"
 Grid.Row="0"
 HorizontalAlignment="Center"
 Margin="0,0,0,12"
 StartDate="{Binding FromDate, Mode=TwoWay}"
 EndDate="{Binding ToDate, Mode=TwoWay}" />

 <!-- Modes tabs (below the period bar) -->
 <TabControl Grid.Row="1" Background="{StaticResource Control.Background}" Foreground="{StaticResource Control.Foreground}">
 <TabItem Header="Przegląd" />
 <TabItem Header="Categorie" />
 <TabItem Header="Czas" />
 <TabItem Header="Cashflow" />
 <TabItem Header="Subskrypcje" />
 <TabItem Header="Budżety" />
 <TabItem Header="Cele" />
 </TabControl>

 <!-- Charts + drilldown area -->
 <Grid Grid.Row="2" Margin="0,8,0,0">
 <Grid.ColumnDefinitions>
 <ColumnDefinition Width="2*" />
 <ColumnDefinition Width="*" />
 </Grid.ColumnDefinitions>

 <ctrls:DonutChartControl x:Name="MainChart" Grid.Column="0" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" Background="Transparent" />

 <StackPanel Grid.Column="1">
 <TextBlock Text="Szczegóły" FontWeight="Bold" Margin="0,0,0,8" />
 <DataGrid x:Name="SummaryGrid" AutoGenerateColumns="False" IsReadOnly="True" Height="220" Background="{StaticResource Control.Background}" Foreground="{StaticResource Control.Foreground}" RowBackground="{x:Null}" ItemsSource="{Binding SummaryDetails}">
 <DataGrid.Columns>
 <DataGridTextColumn Header="Kategoria" Binding="{Binding Name}" />
 <DataGridTextColumn Header="Kwota" Binding="{Binding Amount, StringFormat=N2}" />
 </DataGrid.Columns>
 </DataGrid>

 <Button x:Name="BackButton" Content="Wróć" Visibility="{Binding IsDrilldownActive, Converter={StaticResource InverseBoolToVisibilityConverter}}" Command="{Binding BackCommand}" Margin="0,8,0,0"/>

 <TextBlock Text="Kliknij element wykresu aby zobaczyć drilldown" FontStyle="Italic" Margin="0,8,0,0" />
 <DataGrid x:Name="DrilldownGrid" AutoGenerateColumns="False" IsReadOnly="True" Height="220" Background="{StaticResource Control.Background}" Foreground="{StaticResource Control.Foreground}" RowBackground="{x:Null}" ItemsSource="{Binding FilteredTransactions}" Margin="0,8,0,0"
 Visibility="{Binding IsDrilldownActive, Converter={StaticResource BoolToVisibilityConverter}}">
 <DataGrid.Columns>
 <DataGridTextColumn Header="Data" Binding="{Binding TransactionDate}" />
 <DataGridTextColumn Header="Kategoria" Binding="{Binding Category}" />
 <DataGridTextColumn Header="Podkategoria" Binding="{Binding Subcategory}" />
 <DataGridTextColumn Header="Kwota" Binding="{Binding Amount, StringFormat=N2}" />
 <DataGridTextColumn Header="Waluta" Binding="{Binding Currency}" />
 </DataGrid.Columns>
 </DataGrid>
 </StackPanel>
 </Grid>
 </Grid>
 </Border>

 <!-- RIGHT: Smart Insights (moved to top row) -->
 <Border Grid.Row="0" Grid.Column="2" Background="{StaticResource Surface.Background}" Padding="12" CornerRadius="6" BorderBrush="{StaticResource Surface.Border}" BorderThickness="1">
 <StackPanel>
 <TextBlock Text="Analizy finansowe" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,8" />

 <!-- Summary totals -->
 <Border Background="{StaticResource Control.Background}" CornerRadius="4" Padding="8" Margin="0,0,0,8" BorderBrush="{StaticResource Surface.Border}" BorderThickness="1">
 <StackPanel>
 <StackPanel Orientation="Horizontal" Margin="0,2">
 <TextBlock Text="Suma wydatków:" FontWeight="SemiBold" Width="160" />
 <TextBlock Text="{Binding ExpensesTotalStr}" HorizontalAlignment="Right" />
 </StackPanel>
 <StackPanel Orientation="Horizontal" Margin="0,2">
 <TextBlock Text="Suma przychodów:" FontWeight="SemiBold" Width="160" />
 <TextBlock Text="{Binding IncomesTotalStr}" HorizontalAlignment="Right" />
 </StackPanel>
 <StackPanel Orientation="Horizontal" Margin="0,2">
 <TextBlock Text="Oszczędności:" FontWeight="SemiBold" Width="160" />
 <TextBlock Text="{Binding BalanceTotalStr}" HorizontalAlignment="Right" />
 </StackPanel>
 </StackPanel>
 </Border>

 <ItemsControl ItemsSource="{Binding Insights}">
 <ItemsControl.ItemTemplate>
 <DataTemplate>
 <Border Background="{StaticResource Control.Background}" CornerRadius="4" Padding="8" Margin="0,0,0,8" BorderBrush="{StaticResource Surface.Border}" BorderThickness="1">
 <TextBlock Text="{Binding}" TextWrapping="Wrap" Foreground="{StaticResource Control.Foreground}" />
 </Border>
 </DataTemplate>
 </ItemsControl.ItemTemplate>
 </ItemsControl>

 <TextBlock Text="KPI" FontWeight="Bold" Margin="0,12,0,6" />
 <ItemsControl ItemsSource="{Binding KPIList}">
 <ItemsControl.ItemTemplate>
 <DataTemplate>
 <StackPanel Orientation="Horizontal" HorizontalAlignment="Stretch" Margin="0,2">
 <TextBlock Text="{Binding Key}" FontWeight="SemiBold" Width="160" />
 <TextBlock Text="{Binding Value}" HorizontalAlignment="Right" />
 </StackPanel>
 </DataTemplate>
 </ItemsControl.ItemTemplate>
 </ItemsControl>
 </StackPanel>
 </Border>
 </Grid>
</UserControl>